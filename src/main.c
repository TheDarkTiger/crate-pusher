#include <stdint.h>
#include <gb/gb.h>

// ;)
#include "MLP.h"

const unsigned char ROM[] =
{
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // White
	0x00,0x00,0x42,0x42,0x66,0x66,0x7E,0x7E,0x5A,0x5A,0x7E,0x7E,0x3C,0x3C,0x00,0x00, // Cat head
	0x07,0x00,0x3F,0x00,0x7F,0x00,0xFF,0x00,0xFF,0x00,0x7F,0x00,0x1F,0x00,0x03,0x00, // Shadow
	0xE0,0x00,0xFC,0x00,0xFE,0x00,0xFF,0x00,0xFF,0x00,0xFE,0x00,0xF8,0x00,0xC0,0x00,
	0x00,0x00,0x0C,0x0C,0x0C,0x0C,0x0F,0x0F,0x0F,0x0C,0x0F,0x0F,0x0C,0x0C,0x0C,0x0C, // Kate
	0x00,0x00,0x00,0x00,0x00,0x00,0xF8,0xF8,0xF8,0x08,0xFC,0x04,0xCC,0xB4,0xFC,0x84,
	0x0E,0x0E,0x0E,0x0E,0x0F,0x0F,0x0F,0x0C,0x0F,0x0F,0x0C,0x0F,0xFD,0xFF,0xFC,0xFC,
	0xC6,0xBA,0xFE,0x82,0xC6,0x3A,0xFF,0x01,0xFF,0xFF,0x85,0xFF,0x4B,0xFF,0x85,0x85,
	0xFF,0xFF,0x40,0xFF,0xBF,0x60,0xDF,0x30,0xEF,0x18,0xF7,0x0C,0xFF,0xFF,0x00,0xFF, // Floor
	0xFF,0xFF,0x04,0xFF,0xFB,0x0C,0xF7,0x18,0xEF,0x30,0xDF,0x60,0xFF,0xFF,0x00,0xFF,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x7F,0x7F,0x8F,0x90,0x83,0x88,0x80,0xC4,0xC0,0xA2,0xC0,0x91,0xE0,0x89,0xC0,0x86, // Crate 1
	0xFE,0xFE,0xF1,0x09,0xC1,0x13,0x01,0x23,0x01,0x47,0x01,0x8B,0x05,0x13,0x01,0x23,
	0xF0,0x84,0xC0,0x88,0xC0,0x91,0xC0,0xA2,0x80,0xC4,0x83,0x88,0x80,0xBF,0x7F,0x7F,
	0x0D,0x63,0x01,0x93,0x01,0x8B,0x01,0x47,0x01,0x23,0xC1,0x13,0x03,0xFF,0xFE,0xFE,
	0x7F,0x7F,0xA0,0x80,0xD2,0xA1,0xA1,0x8E,0x88,0x90,0x80,0x90,0xA0,0x91,0x91,0xA2, // Crate 2
	0xFE,0xFE,0x05,0x01,0x4B,0x85,0x85,0x71,0x11,0x09,0x01,0x09,0x05,0x89,0x09,0x45,
	0x90,0xA2,0xA0,0x91,0x80,0x90,0x88,0x90,0xA1,0x8E,0xD2,0xA1,0xA0,0x80,0x7F,0x7F,
	0x89,0x45,0x05,0x89,0x01,0x09,0x11,0x09,0x85,0x71,0x4B,0x85,0x05,0x01,0xFE,0xFE,
	0x7F,0x7F,0x80,0x80,0xA8,0x81,0x88,0x81,0x90,0x82,0x90,0x82,0xA1,0x84,0xA1,0x84, // Crate 3
	0xFE,0xFE,0x01,0x01,0x15,0x81,0x11,0x81,0x09,0x41,0x09,0x41,0x85,0x21,0x85,0x21,
	0x81,0x88,0xA1,0x88,0x80,0x90,0x83,0x90,0x80,0xA0,0x80,0xBF,0x80,0x80,0x7F,0x7F,
	0x81,0x11,0x85,0x11,0x01,0x09,0xC1,0x09,0x01,0x05,0x01,0xFD,0x01,0x01,0xFE,0xFE,
	0x7F,0x7F,0x8F,0x90,0x80,0x80,0x80,0xC0,0xC0,0x80,0xC0,0x80,0xC0,0x81,0xC0,0x81, // Crate 4
	0xFE,0xFE,0xF1,0x09,0x01,0x03,0x01,0x03,0x01,0x03,0x01,0x03,0x01,0x03,0x01,0x03,
	0xC0,0x82,0xC0,0x83,0xC0,0x80,0xC0,0x80,0x80,0xC0,0x80,0x80,0x80,0xBF,0x7F,0x7F,
	0x01,0x43,0x01,0xC3,0x01,0x43,0x01,0x03,0x01,0x03,0x01,0x03,0x03,0xFF,0xFE,0xFE,
	0x7F,0x7F,0x8F,0x90,0x80,0x80,0x80,0xC0,0xC0,0x80,0xC0,0x80,0xC0,0x81,0xC0,0x81, // Crate 5
	0xFE,0xFE,0xF1,0x09,0x01,0x03,0x01,0x03,0x01,0x03,0x01,0x03,0x01,0xC3,0x01,0x03,
	0xC0,0x81,0xC0,0x80,0xC0,0x83,0xC0,0x80,0x80,0xC0,0x80,0x80,0x80,0xBF,0x7F,0x7F,
	0x01,0x83,0x01,0x43,0x01,0xC3,0x01,0x03,0x01,0x03,0x01,0x03,0x03,0xFF,0xFE,0xFE
};

typedef struct {
	uint8_t x;
	uint8_t y;
	uint8_t side;
	uint8_t holding;
} s_player;
const uint8_t playerYpos[] = {0x0, 0x3, 0x7, 0xB};

typedef struct {
	uint8_t levelNumber;
	uint8_t level[32];
	uint8_t moves;
	s_player player;
} s_gameState;

void draw_playfield( void );

void level_load( uint8_t number );
void level_display( void );


s_gameState g_game;

void main( void )
{
	// Don't mess while we configure stuff.
	disable_interrupts();
	DISPLAY_OFF;
	LCDC_REG |= 0x10; // BG at 0x8000
	
	// Set palettes
	BGP_REG		= 0xE4U;
	OBP0_REG	= 0xE4U;
	OBP1_REG	= 0xE4U;
	
	// Background
	SCX_REG = 0;
	SCY_REG = 0;
	set_bkg_data( 0, 32, ROM );
	
	// Sprite
	SPRITES_8x8;
	set_sprite_data( 0, 28, ROM );
	set_sprite_tile( 0, 4 );
	set_sprite_tile( 1, 5 );
	set_sprite_tile( 2, 6 );
	set_sprite_tile( 3, 7 );
	set_sprite_prop( 0, 0 );
	set_sprite_prop( 1, 0 );
	set_sprite_prop( 2, 0 );
	set_sprite_prop( 3, 0 );
	SHOW_SPRITES;
	
	SHOW_BKG;
	HIDE_WIN;
	
	// Release the hound
	DISPLAY_ON;
	enable_interrupts();
	
	// Init game state
	g_game.levelNumber = 0;
	g_game.level[0] = 0;
	g_game.moves = 0;
	g_game.player.x = 80+4;
	g_game.player.y = 0;
	g_game.player.side = 0;
	g_game.player.holding = 0;
	
	draw_playfield();
	level_load( 1 );
	
	// Main loop
	unsigned char mode = 0; //0: album, 1: page, 2: roll, 3: picture, 4: viewing
	unsigned char modePrevious = 255; // Force update
	unsigned char joystickState = 0;
	unsigned char joystickStatePrevious = 0;
	while(1)
	{
		wait_vbl_done();
		
		// Controls
		joystickStatePrevious = joystickState;
		joystickState = joypad();
		if( mode < 4 )
		{
			// (P^S) -> is the state the same ?
			// (P^S)&S -> is the touch pressed ?
			// (P^S)&P -> is the touch released ?
			const unsigned char joystickPressed = ((joystickStatePrevious ^ joystickState) & joystickState );
			
			if( joystickPressed & J_LEFT )
			{
				g_game.player.x = 80+4;
				g_game.player.side = 0;
				set_sprite_tile( 0, 4 );
				set_sprite_tile( 1, 5 );
				set_sprite_tile( 2, 6 );
				set_sprite_tile( 3, 7 );
				set_sprite_prop( 0, 0 );
				set_sprite_prop( 1, 0 );
				set_sprite_prop( 2, 0 );
				set_sprite_prop( 3, 0 );
			}
			if( joystickPressed & J_RIGHT )
			{
				g_game.player.x = 72+4;
				g_game.player.side = 1;
				set_sprite_tile( 0, 5 );
				set_sprite_tile( 1, 4 );
				set_sprite_tile( 2, 7 );
				set_sprite_tile( 3, 6 );
				set_sprite_prop( 0, S_FLIPX );
				set_sprite_prop( 1, S_FLIPX );
				set_sprite_prop( 2, S_FLIPX );
				set_sprite_prop( 3, S_FLIPX );
			}
			if( joystickPressed & J_UP )
			{
				if( g_game.player.y > 0 )
				{
					g_game.player.y -= 1;
				}else{
					g_game.player.y = 0;
				}
			}
			if( joystickPressed & J_DOWN )
			{
				if( g_game.player.y < 3 )
				{
					g_game.player.y += 1;
				}else{
					g_game.player.y = 3;
				}
			}
			
			if( joystickPressed & J_A )
			{
				g_game.player.holding++;
				if( g_game.player.holding > 5 )
				{
					g_game.player.holding = 0;
				}
				
				if( g_game.player.holding > 0 )
				{
					uint8_t tmp = g_game.player.holding*4;
					set_sprite_tile( 4, 8+tmp );
					set_sprite_tile( 5, 9+tmp );
					set_sprite_tile( 6, 10+tmp );
					set_sprite_tile( 7, 11+tmp );
				}
				//play_SFX( sfx_sweep_up );
			}
			if( joystickPressed & J_B )
			{
				g_game.player.holding = 0;
				//play_SFX( sfx_sweep_down );
			}
			
		}
		
		// Update player
		uint8_t X = g_game.player.x;
		uint8_t Y = 18+(32*g_game.player.y);
		move_sprite( 0, X,Y );
		move_sprite( 1, X+8,Y );
		move_sprite( 2, X,Y+8 );
		move_sprite( 3, X+8,Y+8 );
		
		if( g_game.player.holding != 0 )
		{
			int8_t o = g_game.player.side==0?-12:12;
			move_sprite( 4, X+o,Y-2 );
			move_sprite( 5, X+o+8,Y-2 );
			move_sprite( 6, X+o,Y+6 );
			move_sprite( 7, X+o+8,Y+6 );
		}else{
			move_sprite( 4, 0,0 );
			move_sprite( 5, 0,0 );
			move_sprite( 6, 0,0 );
			move_sprite( 7, 0,0 );
		}
		
	}
}

// Loads a level
void level_load( uint8_t number )
{
	g_game.levelNumber = number;
	
	//TODO make a generator like:
	// 7-6th bits -> is number of type of crates-1 (0->1 crate type, 4->5 crates type)
	// 5-0th bits -> number of switches
	
	// Hardcoded for now to test
	g_game.level[0] = 1;
	g_game.level[6] = 1;
	g_game.level[7] = 1;
	g_game.level[8] = 2;
	g_game.level[15] = 2;
	g_game.level[16] = 3;
	g_game.level[17] = 2;
	g_game.level[22] = 3;
	g_game.level[23] = 3;
	
	level_display();
}

void draw_playfield( void )
{
	// Clear screen
	const uint8_t blank[20] = {0,0,0,0,0,0,0,0,0,2,3,0,0,0,0,0,0,0,0,0};
	for( unsigned char i=0; i<18; i++ )
	{
		set_bkg_tiles( 0,i, 20,1, blank );
	}
	
	// Background
	const uint8_t tmp[20] = {8,9,8,9,8,9,8,9,0,0,0,0,8,9,8,9,8,9,8,9};
	set_bkg_tiles( 0,2, 20,1, tmp );
	set_bkg_tiles( 0,6, 20,1, tmp );
	set_bkg_tiles( 0,10, 20,1, tmp );
	set_bkg_tiles( 0,14, 20,1, tmp );
}

void level_display( void )
{
	uint8_t x = 0;
	uint8_t y = 0;
	uint8_t crate[4] = {12,13,14,15};
	for( uint8_t i=0; i<32; i++ )
	{
		if( g_game.level[i] > 0 )
		{
			// X coordinate
			x = i%8;
			if( x > 4 )
			{
				x += 2;
			}
			x *= 2;
			
			// Y coordinate
			y = i/8;
			y *= 4;
			
			// Correct crate tiles
			uint8_t tmp = g_game.level[i]*4;
			crate[0] = 8+tmp;
			crate[1] = 9+tmp;
			crate[2] = 10+tmp;
			crate[3] = 11+tmp;
			
			// Update
			set_bkg_tiles( x,y, 2,2, crate );
		}
	}
}

